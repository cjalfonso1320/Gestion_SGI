{% extends 'home.html' %}
{% block title %}Documentacion{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/acordeon_doc.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/busqueda.css') }}">

<!-- barra de busqeuda -->
<div class="search-container">
    <input type="text" id="searchInput" placeholder="Buscar documentos por nombre...">
</div>
<!-- Botón flotante para subir documentos -->
<div class="upload-fab" onclick="openUploadModal()">
    <i class="fa fa-upload"></i>
</div>

<!-- Modal para subir documentos -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Subir Documento</h2>
            <span class="close" onclick="closeUploadModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="carpeta">Seleccionar Carpeta:</label>
                    <select id="carpeta" name="carpeta" required>
                        <option value="">Seleccione una carpeta...</option>
                        <option value="Procedimientos">Procedimientos</option>
                        <option value="Caracterizacion">Caracterización</option>
                        <option value="Formatos Digitales">Formatos Digitales</option>
                        <option value="Formatos Fisicos">Formatos Fisicos</option>
                        <option value="Formatos Externos">Formatos Externos</option>
                        <option value="Formatos Externos Digitales">Formatos Externos Digitales</option>
                        <option value="Formatos Externos Fisicos">Formatos Externos Fisicos</option>
                        <option value="Plan de Calidad">Plan de Calidad</option>
                        <option value="Requisitos del Cliente">Requisitos del Cliente</option>
                        <option value="Actas de Restauración">Actas de Restauración</option>
                        <option value="Instructivos">Instructivos</option>
                        <option value="Manuales">Manuales</option>
                        <option value="Auditorias IFX">Auditorias IFX</option>
                        <option value="Auditoria Integrum">Auditoria Integrum</option>
                        <option value="Auditoria Inter Servicios">Auditoria Inter Servicios</option>
                        <option value="ISEC Continuidad">ISEC Continuidad</option>
                        <option value="ISEC Proteccion Datos">ISEC Proteccion Datos</option>
                        <option value="ISEC Seguridad Inf">ISEC Seguridad Inf</option>
                        <option value="Comite de Seguridad">Comite de Seguridad</option>
                        <option value="Vulnerabilidades 2024">Vulnerabilidades 2024</option>
                        <option value="Vulnerabilidades 2025">Vulnerabilidades 2025</option>
                        <option value="Vulnerabilidades Anteriores">Vulnerabilidades Anteriores</option>
                        <option value="Revision Seguridad 2021">Revision Seguridad 2021</option>
                        <option value="Revision Seguridad 2022">Revision Seguridad 2022</option>
                        <option value="Revision Seguridad 2023">Revision Seguridad 2023</option>
                        <option value="Revision Seguridad 2024">Revision Seguridad 2024</option>
                        <option value="SST">SST</option>
                        <option value="Encuestas 2019">Encuestas 2019</option>
                        <option value="Encuestas 2020">Encuestas 2020</option>
                        <option value="Encuestas 2021">Encuestas 2021</option>
                        <option value="Sagrilaft">Sagrilaft</option>
                        <option value="Ambiental">Ambiental</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="documento">Seleccionar Documento:</label>
                    <input type="file" id="documento" name="documento" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" required>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeUploadModal()" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Subir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmación para reemplazar -->
<div id="replaceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Documento Existente</h2>
            <span class="close" onclick="closeReplaceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>El documento <strong id="existingFileName"></strong> ya existe en la carpeta seleccionada.</p>
            <p>¿Desea reemplazarlo?</p>
            <div class="form-actions">
                <button type="button" onclick="closeReplaceModal()" class="btn-secondary">Cancelar</button>
                <button type="button" onclick="confirmReplace()" class="btn-warning">Reemplazar</button>
            </div>
        </div>
    </div>
</div>

{% if current_user.rol != 17 and current_user.rol != 20 and current_user.rol != 21 %}
    <div class="doc-accordion">
        <div class="doc-section">Procedimientos</div>
        <div class="doc-content">
            {% include 'users/procedimientos.html' %}
        </div>

        <div class="doc-section">Caracterización</div>
        <div class="doc-content">
            {% for c in caracterizaciones %}
            <div class="filterable-item">
            <iframe src="{{ url_for('doc.ver_caracterizacion', filepath=c.ruta)}}" frameborder="0" width="100%"
                height="600px" style="margin-bottom: 20px;">

            </iframe>
            </div>
            {% endfor %}
        </div>

        {% if current_user.rol != 14 %}
        <div class="doc-section">Formatos</div>
        <div class="doc-content">
            <div class="doc-subsection">Formatos Digitales</div>
            <div class="doc-subcontent">
                {% include 'users/formatosDigitales.html' %}
            </div>

            <div class="doc-subsection">Formato Fisicos</div>
            <div class="doc-subcontent">
                {% include 'users/formatosFisicos.html' %}
            </div>

            {% if formatoExternoDigital and formatoExternoFisico %}
            <div class="doc-subsection">Formatos Externos</div>
            <div class="doc-subcontent">

                <div class="doc-subsubsection">Formato Externo Digital</div>
                <div class="doc-subsubcontent">
                    {% include 'users/formatosExternosDigital.html' %}
                </div>

                <div class="doc-subsubsection">Formato Externo Fisico</div>
                <div class="doc-subsubcontent">
                    {% include 'users/formatosExternosFisico.html' %}
                </div>

            </div>
            {% endif %}
        </div>

        {% if current_user.rol not in [8, 9, 14, 15, 16 ,17, 18, 19, 20] %} <!-- NO MOSTRAR SI EL ID ESTA EN LA LISTA -->
        <div class="doc-section">Plan de Calidad</div>
        <div class="doc-content">
            {% include 'users/planCalidad.html' %}
        </div>

        <div class="doc-section">Requisitos del Cliente</div>
        <div class="doc-content">
            {% include 'users/requisitosCliente.html' %}
        </div>

        {% elif current_user.rol == 9 %} <!-- MOSTRAR SI EL ID ES EL DE T-I -->
        <div class="doc-section">Actas de Restauración</div>
        <div class="doc-content">
            {% include 'users/actasRestauracion.html' %}
        </div>

        <div class="doc-section">Instructivos</div>
        <div class="doc-content">
            {% include 'users/instructivos.html' %}
        </div>
        <div class="doc-section">Manuales</div>
        <div class="doc-content">
            {% include 'users/manuales.html' %}
        </div>

        {% elif current_user.rol == 16 %} <!-- MOSTRAR SI EL ID ES EL DE SGI-->

        <div class="doc-section">Auditorias Proveedores</div>
        <div class="doc-content">
            <div class="doc-subsection">IFX</div>
            <div class="doc-subcontent">
                {% include 'users/auditoriaIFX.html' %}
            </div>

            <div class="doc-subsection">INTEGRUM</div>
            <div class="doc-subcontent">
                {% include 'users/auditoriaIntegrum.html' %}
            </div>

            <div class="doc-subsection">INTER SERVICIOS</div>
            <div class="doc-subcontent">
                {% include 'users/auditoriaInterServicios.html' %}
            </div>

            <div class="doc-subsection">POLITICAS I-SEC</div>
            <div class="doc-subcontent">

                <div class="doc-subsubsection">CONTINUIDAD DEL NEGOCIO</div>
                <div class="doc-subsubcontent">
                    {% include 'users/ISECpoliticaContinuidad.html' %}
                </div>

                <div class="doc-subsubsection">PROTECCION DATOS</div>
                <div class="doc-subsubcontent">
                    {% include 'users/ISECpoliticaProteccionDatos.html' %}
                </div>

                <div class="doc-subsubsection">SEGURIDAD DE LA INF</div>
                <div class="doc-subsubcontent">
                    {% include 'users/ISECpoliticaSeguridadInf.html' %}
                </div>
            </div>
        </div>

        <div class="doc-section">Comite de Seguridad</div>
        <div class="doc-content">
            {% include 'users/comiteSeguridad.html' %}
        </div>

        <div class="doc-section">Informes de Hacking Etico</div>
        <div class="doc-content">   
            LA CARPETA ESTA MUY MAL ESTRUCTURADA
        </div>

        <div class="doc-section">Informes de Vulnerabilidades</div>
        <div class="doc-content">
            <div class="doc-subsection">2024</div>
            <div class="doc-subcontent">
                {% include 'users/vulnerabilidades_2024.html' %}
            </div>

            <div class="doc-subsection">2025</div>
            <div class="doc-subcontent">
                {% include 'users/vulnerabilidades_2025.html' %}
            </div>

            <div class="doc-subsection">Anteriores</div>
            <div class="doc-subcontent">
                {% include 'users/vulnerabilidades_ant.html' %}
            </div>
        </div>

        <div class="doc-section">Instructivos</div>
        <div class="doc-content">
            {% include 'users/instructivos.html' %}
        </div>

        <div class="doc-section">Revision de Seguridad</div>
        <div class="doc-content">
            <div class="doc-subsection">2021</div>
            <div class="doc-subcontent">
                {% include 'users/revisionSeguridad_2021.html' %}
            </div>

            <div class="doc-subsection">2022</div>
            <div class="doc-subcontent">
                {% include 'users/revisionSeguridad_2022.html' %}
            </div>

            <div class="doc-subsection">2023</div>
            <div class="doc-subcontent">
                {% include 'users/revisionSeguridad_2023.html' %}
            </div>

            <div class="doc-subsection">2024</div>
            <div class="doc-subcontent">
                {% include 'users/revisionSeguridad_2024.html' %}
            </div>
        </div>

        {% elif current_user.rol == 18 %} <!-- MOSTRAR SI EL ID ES EL DE COMERCIAL -->
        <div class="doc-section">Encuestas de Satisfacción</div>
        <div class="doc-content">
            <div class="doc-subsection">2019</div>
            <div class="doc-subcontent">
                {% include 'users/encuestas_2019.html' %}
            </div>

            <div class="doc-subsection">2020</div>
            <div class="doc-subcontent">
                {% include 'users/encuestas_2020.html' %}
            </div>

            <div class="doc-subsection">2021</div>
            <div class="doc-subcontent">
                {% include 'users/encuestas_2021.html' %}
            </div>
        </div>
        {% endif %}
    {% endif %}
    </div>
{% elif current_user.rol == 17 %}
        {% if sst_arbol_carpetas %}
            {% include 'users/sst.html' %}
        {% endif %}
{% elif current_user.rol == 20 %}
        {% if archivos_sagrilaft %}
            {% include 'users/sagrilaft.html' %}
        {% endif %}
{% elif current_user.rol == 21 %}
        {% if archivos_ambiental %}
            {% include 'users/ambiental.html' %}
        {% endif %}
{% endif %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{{ url_for('static', filename='js/acordeon_doc.js')}}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const docAccordion = document.querySelector('.doc-accordion');

    // Esta función es la que hace toda la magia
    function filterDocuments() {
        const searchTerm = searchInput.value.toLowerCase();
        
        // Obtenemos TODOS los elementos filtrables dentro del acordeón
        const items = docAccordion.querySelectorAll('.filterable-item');

        items.forEach(item => {
            const itemText = item.textContent.toLowerCase();
            
            // Comparamos el texto del item con el término de búsqueda
            if (itemText.includes(searchTerm)) {
                item.style.display = ''; // Muestra el item si coincide
            } else {
                item.style.display = 'none'; // Oculta el item si no coincide
            }
        });

        // (Opcional pero recomendado) Ocultamos las secciones que se queden vacías
        updateSectionVisibility();
    }
    
    // Esta función revisa cada sección y subsección y la oculta si no tiene items visibles
    function updateSectionVisibility() {
        const allSections = docAccordion.querySelectorAll('.doc-section, .doc-subsection, .doc-subsubsection');
        
        allSections.forEach(section => {
            // Buscamos el contenedor de contenido hermano o hijo
            let content = section.querySelector('.doc-content, .doc-subcontent, .doc-subsubcontent') || section.nextElementSibling;
            
            if (content) {
                // Buscamos si hay algún item visible dentro del contenedor
                const visibleItem = content.querySelector('.filterable-item:not([style*="display: none"])');
                
                if (visibleItem) {
                    section.style.display = ''; // Si hay items, muestra la sección
                } else {
                    section.style.display = 'none'; // Si no hay, oculta la sección
                }
            }
        });
    }

    // Escuchamos el evento 'input' para filtrar mientras el usuario escribe
    searchInput.addEventListener('input', filterDocuments);
});
</script>
{% endblock %}